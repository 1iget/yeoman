#!/usr/bin/env node
'use strict';

var fs = require('fs');
var path = require('path');
var nopt = require('nopt');
var colors = require('colors');
var _ = require('lodash');
var pkg = require('../package.json');
var findup = require('findup-sync');
var updateNotifier = require('update-notifier');

var args = process.argv.slice(2);
var flags = nopt({}, {}, process.argv, 2);
var cmd = args[0];
var helpScreen = _.template(fs.readFileSync(path.join(__dirname, 'help.txt'), 'utf8'));


function runInit() {
 // TODO: Init the specified generator
}

function runGrunt() {
  var gruntfile = findup('Gruntfile.{js,coffee}', {nocase: true});
  var dir = path.resolve(gruntfile, '../node_modules/grunt');
  require(dir).cli();
}

function runBower() {
  /*var gruntfile = findup('Gruntfile.{js,coffee}', {nocase: true});
  var dir = path.resolve(gruntfile, '../node_modules/bower');*/
  // Should Bower be local dep?
  // + users can decide to upgrade whenever
  // - one more local dep we have to add to each generator
  require('bower').commands[cmd].line(process.argv)
    .on('error', console.error)
    .on('data', console.log);
}

// TODO: Update docs to flag `--no-insight`
if (!process.env.yeoman_test || flags.insight !== false) {

}

// TODO: Update docs to flag `--no-update-notifier`
if (!process.env.yeoman_test || flags['update-notifier'] !== false) {
  var notifier = updateNotifier({
    packagePath: '../package',
    packageName: 'yeoman',
    packageVersion: '0.9.3'
  });

  if (notifier.update) {
    notifier.notify(true);
  }
}

if (flags.version) {
  return console.log(pkg.version);
}

if (cmd === '--help') {
  return console.log(helpScreen());
}

switch (cmd) {
  case 'help':
    console.log(helpScreen());
    break;
  case 'init':
  case 'i':
    runInit();
    break;
  case 'build':
  case 'b':
    process.argv[2] = 'build';
    runGrunt();
    break;
  case 'server':
  case 's':
    process.argv[2] = 'server';
    runGrunt();
    break;
  case 'test':
  case 't':
    process.argv[2] = 'test';
    process.env.yeoman_test = true;
    runGrunt();
    break;
  case 'watch':
    console.log(('\nFYI: Yeoman`s watch task is integrated within ' +
      'yeoman server'.bold + ' to combine the dev server, re-compilation and ' +
      'live reloading of changed assets.\n\nContinuing anyway...\n').yellow);
    runGrunt();
    break;
  case 'install':
  case 'uninstall':
  case 'update':
  case 'list':
  case 'ls':
  case 'search':
  case 'lookup':
    runBower();
    break;
  default:
    console.log(helpScreen());
    break;
}
